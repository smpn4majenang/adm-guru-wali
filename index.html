<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Administrasi Guru Wali Digital</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        navy: { 900: '#1e293b', 800: '#334155', DEFAULT: '#1a2233' },
                        brand: { blue: '#2563eb', light: '#f1f5f9' }
                    }
                }
            }
        }
    </script>

    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .nav-item-active { background-color: #2563eb !important; color: white !important; border-radius: 8px; }
        
        /* Form Styling */
        .form-label { font-size: 0.8rem; font-weight: 600; color: #334155; margin-bottom: 0.5rem; display: block; }
        .form-input-custom { border: 1px solid #e2e8f0; border-radius: 6px; padding: 0.75rem 1rem; transition: all 0.2s; width: 100%; background-color: #fff; font-size: 0.9rem; color: #1e293b; }
        .form-input-custom:focus { outline: none; border-color: #2563eb; ring: 1px; ring-color: #2563eb; }
        .form-input-readonly { background-color: #f8fafc; cursor: not-allowed; color: #64748b; border-color: #f1f5f9; }
        
        .section-title { font-size: 1rem; font-weight: 800; color: #1e293b; margin-top: 2.5rem; margin-bottom: 1.5rem; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 2px solid #2563eb; padding-bottom: 0.5rem; display: inline-block; }
        
        .action-btn { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .action-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); }

        .form-row { display: flex; flex-direction: column; margin-bottom: 1.5rem; }

        /* Loading Overlay */
        #loader { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 100; align-items: center; justify-content: center; }

        @media print { 
            .no-print { display: none !important; } 
            .print-area { box-shadow: none !important; border: none !important; margin: 0 !important; width: 100% !important; padding: 0 !important; }
            body { background: white; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans h-screen flex overflow-hidden">

    <div id="loader"><div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-brand-blue"></div></div>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="bg-[#1e293b] text-slate-300 w-64 flex-shrink-0 flex flex-col z-50 transform -translate-x-full md:translate-x-0 transition-transform duration-300 no-print">
        <div class="p-6 text-white font-bold text-center border-b border-slate-700/50">
            <div class="text-[14px] leading-tight tracking-widest uppercase">ADMINISTrasi GURU WALI</div>
        </div>
        <nav id="navLinks" class="flex-1 px-4 py-6 space-y-1 overflow-y-auto custom-scrollbar"></nav>
        <div class="p-4 border-t border-slate-700/50 text-center">
            <button onclick="app.logout()" class="text-xs text-slate-500 hover:text-white transition-colors">Keluar Aplikasi</button>
        </div>
    </aside>

    <!-- CONTENT -->
    <main class="flex-1 flex flex-col min-w-0 h-screen overflow-hidden">
        <!-- Header Atas (No-Print) -->
        <header class="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-8 no-print">
            <h2 id="pageTitle" class="font-bold text-slate-700">Profil Murid</h2>
            <div class="flex gap-2">
                <button onclick="app.toggleHistory()" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg text-sm transition-all">
                    <i class="fas fa-history mr-2"></i> Riwayat Data
                </button>
            </div>
        </header>

        <div id="contentArea" class="flex-1 overflow-y-auto p-4 md:p-8 custom-scrollbar">
            <!-- App content injected here -->
        </div>
    </main>

    <!-- Modal Riwayat (No-Print) -->
    <div id="historyModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[60] no-print">
        <div class="bg-white w-full max-w-2xl rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh]">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="font-bold text-lg">Riwayat Data Tersimpan</h3>
                <button onclick="app.toggleHistory()" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
            </div>
            <div id="historyList" class="flex-1 overflow-y-auto p-6 space-y-3 bg-slate-50">
                <!-- List riwayat muncul di sini -->
            </div>
        </div>
    </div>

    <!-- FLOATING ACTIONS -->
    <div class="fixed bottom-8 right-8 flex flex-col gap-3 no-print">
        <button type="submit" form="mainForm" class="action-btn bg-purple-600" title="Simpan Data ke Sheets"><i class="fas fa-save"></i></button>
        <button onclick="window.print()" class="action-btn bg-blue-500" title="Cetak Data"><i class="fas fa-print"></i></button>
    </div>

    <script>
        // MASUKKAN URL WEB APP GAS ANDA DI SINI
        const API_URL = "https://script.google.com/macros/s/AKfycbyEF6TPuArduYhyxQB5_t2_RulNyuxVIvYjq3mVio4r9zURc49THfcE24FAWvv7wo5f/exec"; 
        
        const CONFIG = {
            MENUS: [
                { id: 'profil-murid', label: 'Profil Murid', icon: 'fa-user-graduate' },
                { id: 'jurnal', label: 'Jurnal Pertemuan', icon: 'fa-book' },
                { id: 'laporan', label: 'Laporan Perkembangan', icon: 'fa-chart-line' },
                { id: 'rencana', label: 'Rencana Pengembangan Diri', icon: 'fa-user-edit' },
                { id: 'divider', label: '', icon: '' },
                { id: 'identitas', label: 'Isi Identitas', icon: 'fa-id-card' },
                { id: 'program', label: 'Program Kerja', icon: 'fa-tasks' },
                { id: 'jadwal', label: 'Jadwal Kegiatan', icon: 'fa-calendar-alt' },
                { id: 'data-murid', label: 'Data Murid', icon: 'fa-users' }
            ]
        };

        // State Aplikasi
        let dbMurid = [];
        let savedData = [];
        let currentMenu = 'profil-murid';

        const app = {
            init: async () => {
                app.showLoader(true);
                app.renderSidebar();
                await app.fetchDataMurid();
                app.navigate('profil-murid');
                app.showLoader(false);
            },

            showLoader: (show) => {
                document.getElementById('loader').style.display = show ? 'flex' : 'none';
            },

            fetchDataMurid: async () => {
                // Simulasi fetching dari Sheets jika API_URL tersedia
                try {
                    if (API_URL) {
                        const res = await fetch(`${API_URL}?menu=data-murid`);
                        const data = await res.json();
                        if (data && data.length > 0) dbMurid = data;
                    }
                } catch (e) {
                    console.error("Gagal mengambil data murid:", e);
                    // Fallback mockup
                    dbMurid = [
                        { nama: "Budi Santoso", nis: "12345", kelas: "X-A", guru: "Siti Aminah, S.Pd", tahun: "2023" },
                        { nama: "Ani Wijaya", nis: "12346", kelas: "X-A", guru: "Siti Aminah, S.Pd", tahun: "2023" }
                    ];
                }
            },

            renderSidebar: () => {
                const container = document.getElementById('navLinks');
                container.innerHTML = CONFIG.MENUS.map(m => {
                    if(m.id === 'divider') return `<div class="my-4 border-t border-slate-700/30"></div>`;
                    return `
                        <button onclick="app.navigate('${m.id}')" id="nav-${m.id}" 
                            class="w-full flex items-center gap-3 px-4 py-3 text-[13px] font-medium transition-all text-slate-400 hover:text-white group text-left">
                            <i class="fas ${m.icon} w-5"></i>
                            <span>${m.label}</span>
                        </button>
                    `;
                }).join('');
            },

            navigate: (id) => {
                currentMenu = id;
                document.querySelectorAll('#navLinks button').forEach(b => b.classList.remove('nav-item-active'));
                const activeBtn = document.getElementById(`nav-${id}`);
                if(activeBtn) activeBtn.classList.add('nav-item-active');
                
                const menu = CONFIG.MENUS.find(m => m.id === id);
                document.getElementById('pageTitle').innerText = menu.label;
                
                app.renderPage(id);
            },

            renderPage: (id) => {
                const area = document.getElementById('contentArea');
                const menu = CONFIG.MENUS.find(m => m.id === id);
                
                let html = `<div class="max-w-3xl mx-auto bg-white p-8 md:p-12 shadow-sm border border-slate-100 rounded-sm print-area min-h-screen">`;
                html += `<div class="border-b-4 border-double border-slate-800 pb-4 mb-8 text-center">`;
                html += `<h1 class="text-2xl font-black text-slate-900 uppercase tracking-widest">${menu.label}</h1>`;
                html += `<p class="text-xs text-slate-500 mt-1 uppercase tracking-widest font-bold">Administrasi Guru Wali Digital</p>`;
                html += `</div>`;
                html += `<form id="mainForm" onsubmit="app.handleSave(event)">`;

                switch(id) {
                    case 'profil-murid': html += app.templateProfilMurid(); break;
                    case 'jurnal': html += app.templateJurnal(); break;
                    case 'laporan': html += app.templateLaporan(); break;
                    case 'rencana': html += app.templateRencana(); break;
                    case 'identitas': html += app.templateIdentitas(); break;
                    case 'program': html += app.templateProgram(); break;
                    case 'jadwal': html += app.templateJadwal(); break;
                    case 'data-murid': html += app.templateDataMurid(); break;
                }

                html += `</form></div>`;
                area.innerHTML = html;
            },

            // --- TEMPLATES (1 Kolom per Baris) ---
            templateProfilMurid: () => `
                <div class="form-row">
                    <label class="form-label">Nama Lengkap Murid</label>
                    <select name="nama_murid" onchange="app.fillMurid(this.value)" class="form-input-custom" required>
                        <option value="">Pilih Murid...</option>
                        ${dbMurid.map(m => `<option value="${m.nama}">${m.nama}</option>`).join('')}
                    </select>
                </div>
                <div class="form-row"><label class="form-label">NIS / NISN</label><input type="text" id="m_nis" name="nis" class="form-input-custom form-input-readonly" readonly></div>
                <div class="form-row"><label class="form-label">Kelas</label><input type="text" id="m_kelas" name="kelas" class="form-input-custom form-input-readonly" readonly></div>
                <div class="form-row"><label class="form-label">Nama Guru Wali</label><input type="text" id="m_guru" name="guru" class="form-input-custom form-input-readonly" readonly></div>
                <div class="form-row"><label class="form-label">Tahun Masuk</label><input type="text" id="m_tahun" name="tahun" class="form-input-custom form-input-readonly" readonly></div>

                <div class="section-title">A. Data Diri & Keluarga</div>
                <div class="form-row"><label class="form-label">Alamat Lengkap</label><textarea name="alamat" class="form-input-custom" rows="2"></textarea></div>
                <div class="form-row"><label class="form-label">No. Telepon / WhatsApp</label><input type="text" name="no_telp" class="form-input-custom"></div>
                <div class="form-row"><label class="form-label">Nama Orang Tua / Wali</label><input type="text" name="nama_ortu" class="form-input-custom"></div>
            `,

            templateJurnal: () => `
                <div class="form-row">
                    <label class="form-label">Nama Murid</label>
                    <select name="nama_murid" class="form-input-custom" required>
                        <option value="">Pilih Murid...</option>
                        ${dbMurid.map(m => `<option value="${m.nama}">${m.nama}</option>`).join('')}
                    </select>
                </div>
                <div class="form-row"><label class="form-label">Tanggal Pertemuan</label><input type="date" name="tanggal" class="form-input-custom"></div>
                <div class="form-row"><label class="form-label">Ringkasan Pembahasan</label><textarea name="ringkasan" class="form-input-custom" rows="4"></textarea></div>
                <div class="form-row"><label class="form-label">Tindak Lanjut Murid</label><textarea name="rtl_murid" class="form-input-custom" rows="3"></textarea></div>
            `,

            // ... (Template lainnya tetap sama strukturnya) ...

            // --- FUNGSI RIWAYAT & INTERAKSI ---

            toggleHistory: async () => {
                const modal = document.getElementById('historyModal');
                const list = document.getElementById('historyList');
                
                if (modal.classList.contains('hidden')) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    app.showLoader(true);
                    
                    // Simulasi Ambil Data dari GAS
                    list.innerHTML = `<p class="text-center text-slate-400 py-10">Mengambil data dari server...</p>`;
                    
                    try {
                        // Di sini aslinya memanggil API_URL?menu=currentMenu
                        // Kita simulasikan data riwayat
                        setTimeout(() => {
                            const dataMock = [
                                { id: 1, nama_murid: "Budi Santoso", tanggal: "2024-05-12", catatan: "Pertemuan rutin pertama" },
                                { id: 2, nama_murid: "Ani Wijaya", tanggal: "2024-05-15", catatan: "Konsultasi akademik" }
                            ];
                            
                            list.innerHTML = dataMock.map(item => `
                                <div class="bg-white p-4 rounded-lg border border-slate-200 hover:border-brand-blue cursor-pointer transition-all flex justify-between items-center group"
                                     onclick="app.loadDataToForm(${JSON.stringify(item).replace(/"/g, '&quot;')})">
                                    <div>
                                        <div class="font-bold text-slate-800">${item.nama_murid}</div>
                                        <div class="text-xs text-slate-500">${item.tanggal || 'No Date'}</div>
                                    </div>
                                    <div class="opacity-0 group-hover:opacity-100 text-brand-blue text-xs font-bold uppercase">Tampilkan & Cetak &rarr;</div>
                                </div>
                            `).join('');
                            app.showLoader(false);
                        }, 500);
                    } catch (e) {
                        list.innerHTML = `<p class="text-red-500 text-sm">Gagal memuat riwayat.</p>`;
                        app.showLoader(false);
                    }
                } else {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }
            },

            loadDataToForm: (data) => {
                const form = document.getElementById('mainForm');
                Object.keys(data).forEach(key => {
                    const input = form.elements[key];
                    if (input) {
                        input.value = data[key];
                        if (key === 'nama_murid' && currentMenu === 'profil-murid') app.fillMurid(data[key]);
                    }
                });
                app.toggleHistory(); // Tutup modal
            },

            fillMurid: (nama) => {
                const murid = dbMurid.find(m => m.nama === nama);
                if (murid) {
                    document.getElementById('m_nis').value = murid.nis;
                    document.getElementById('m_kelas').value = murid.kelas;
                    document.getElementById('m_guru').value = murid.guru;
                    document.getElementById('m_tahun').value = murid.tahun;
                }
            },

            handleSave: async (e) => {
                e.preventDefault();
                app.showLoader(true);
                
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                data.menu = currentMenu; // Tambahkan info menu untuk GAS

                try {
                    if (API_URL) {
                        await fetch(API_URL, {
                            method: "POST",
                            body: JSON.stringify(data)
                        });
                        alert("Data Berhasil Disimpan Ke Cloud!");
                    } else {
                        alert("Data Tersimpan di Cache (API_URL belum diisi)");
                    }
                } catch (e) {
                    alert("Gagal terhubung ke Google Sheets. Pastikan API_URL benar.");
                }
                app.showLoader(false);
            },

            logout: () => { window.location.reload(); }
        };

        window.onload = app.init;
    </script>
</body>
</html>
